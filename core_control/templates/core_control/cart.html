{% extends "core_control/base/base.html" %}
{% load static %}

{% block title %}My Cart{% endblock title %}


{% block content %}

<div class="container rounded-2 bg-light mt-4 mb-4">
    <div class="row">
        <div class="d-flex justify-content-between align-items-center w-100">
            <h2 class="mb-4">My Cart</h2>

            <a href="/aqib-plaltes/private-plate/explore" class="con-shoping">Continue Shopping</a>
 
        </div>
        <div class="col-lg-8 col-md-12 col-sm-12 p-5" id="usercart">

            

        </div>

        <div class="col-lg-4 col-md-12 col-sm-12 p-5">
            <h3>Order summary</h3>
            <div class="w-100 mb-4 p-4 rounded-4"
                style="height: 12rem; box-shadow: rgba(0, 0, 0, 0.12) 0px 1px 3px, rgba(0, 0, 0, 0.24) 0px 1px 2px;">
            <div class="mt-3 mb-4 w-100">
                <h5>Total items: <span class="ms-5" id="itemquan"></span></h5> 
                
            </div>
            
            <div class="mt-5  w-100">
                <h3> <span id="itemprice"></span></h3> 
            
            </div>
           
            </div>
            <div class="mt-3 mb-3">
                <a href="#" class="w-100 btn-lg btn btn-warning">Checkout</a>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block js %}
function updateCartUI(cards = localStorage.getItem("cart")) {
    // Parse the cart items from string to object if it's a string
    if (typeof cards === 'string') {
        cards = JSON.parse(cards);
    }

    // Assuming you have a container element where you want to display cart items
    const cartContainer = document.getElementById("usercart");

    // Clear the existing content in the container
    cartContainer.innerHTML = '';

    if (cards && cards.length > 0) {
        let totalItems = 0; // Variable to keep track of total items in cart
        let totalPrice = 0; // Variable to keep track of total price of items in cart

        // Loop through each cart item and create HTML elements to display them
        cards.forEach((item, index) => {
            totalItems += item.quantity; // Increment total items
            totalPrice += item.price * item.quantity; // Increment total price

            const cardElement = document.createElement("div");
            cardElement.classList.add("d-flex", "justify-content-between", "align-items-center", "rounded", "pe-2", "pt-2", "pb-2", "ps-2", "mb-3");
            cardElement.style.height = "6.9rem";
            cardElement.style.boxShadow = "rgba(50, 50, 93, 0.25) 0px 2px 5px -1px, rgba(0, 0, 0, 0.3) 0px 1px 3px -1px";

            cardElement.innerHTML = 
                '<div class="d-flex justify-content-evenly align-items-center h-100 pe-4">' +
                    '<div class="img"><img src="' + item.image + '" class="img-fluid" style="height: 100px;" width="150" alt="Image"></div>'
                    +
                    '<div class="detail p-3">' +
                        '<h4> <a href="#" class="text-decoration-none" style="color: #fcb941;">' + item.name + '</a></h4>' +
                        '<h4><span class="me-1">£</span>' + item.price + '</h4>' +
                    '</div>' +
                '</div>' +
                '<div class="d-flex justify-content-evenly align-items-center h-100">' +
                    '<div class="ms-4 p-2">' +
                        '<h6 class="text-center">Quantity</h6>' +
                        '<div class="d-flex justify-content-between align-items-center p-2 rounded-2" style="background-color: rgb(190, 190, 190);">' +
                            '<div class="me-2">' +
                                '<button class="btn btn-light" onclick="decreaseQuantity(' + index + ')">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-dash" viewBox="0 0 16 16">' +
                                        '<path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8" />' +
                                    '</svg>' +
                                '</button>' +
                            '</div>' +
                            '<h5 id="quantity">' + item.quantity + '</h5>' +
                            '<div class="ms-2">' +
                                '<button class="btn btn-light" onclick="increaseQuantity(' + index + ')">' +
                                    '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-plus" viewBox="0 0 16 16">' +
                                        '<path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4" />' +
                                    '</svg>' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="ms-4">' +
                        '<h6>Total</h6>' +
                        '<h5 id="price"><span class="me-1">£</span>' + item.price * item.quantity + '</h5>' +
                    '</div>' +
                    '<div class="ms-4">' +
                        '<button type="button" class="btn-close" onclick="rm_item(' + index + ')"></button>' +
                    '</div>' +
                '</div>';

            cartContainer.appendChild(cardElement);
        });

        // Display total number of items in cart
        const totalItemsText = document.getElementById("itemquan");
        totalItemsText.innerHTML = totalItems ;
        

        // Display total price of items in cart
        const totalPriceElement = document.getElementById("itemprice");
        totalPriceElement.innerHTML = "<p><span class='me-5'>Subtotal:</span> £ " + totalPrice + "</p>";
    } else {
        // If no items in cart, display a message
        const emptyCard = document.createElement("div");
        emptyCard.classList.add("mt-4", "mb-4", "text-center");
        emptyCard.innerHTML = "<h1>No items added to cart.</h1>";
        emptyCard.style.opacity = "0.5";
        cartContainer.appendChild(emptyCard);

        // Set total price to 0 when cart is empty
        const totalPriceElement = document.getElementById("itemprice");
        const totalItemsText = document.getElementById("itemquan");
        totalPriceElement.innerHTML = "<p>Total price: £ 0</p>";
        totalItemsText.innerHTML = 0;
    }
}

updateCartUI();
// Function to increase quantity for a specific item index
function increaseQuantity(index) {
    // Retrieve cart items from localStorage
    let cartItems = JSON.parse(localStorage.getItem("cart"));

    // Check if the quantity can be increased without exceeding the stock quantity
    if (cartItems[index].quantity < cartItems[index].stock) {
        // Increase quantity for the corresponding item
        cartItems[index].quantity++;

        // Update localStorage with the modified cart items
        localStorage.setItem("cart", JSON.stringify(cartItems));

        // Update the UI to reflect the changes
        updateCartUI(cartItems);
    } else {
        // If increasing the quantity exceeds the stock quantity, throw an error
        console.error("Error: Cannot increase quantity beyond stock quantity.");
    }
}


// Function to decrease quantity for a specific item index
function decreaseQuantity(index) {
    // Retrieve cart items from localStorage
    let cards = JSON.parse(localStorage.getItem("cart"));

    // Ensure quantity doesn't go below 1
    if (cards[index].quantity > 1) {
        // Decrease quantity for the corresponding item
        cards[index].quantity--;

        // Update localStorage with the modified cart items
        localStorage.setItem("cart", JSON.stringify(cards));

        // Update the UI to reflect the changes
        updateCartUI(cards);
    }
}

function rm_item(index) {
    // Retrieve cart items from localStorage
    let cartItems = JSON.parse(localStorage.getItem("cart"));

    // Check if the index is valid
    if (index >= 0 && index < cartItems.length) {
        // Remove the item at the specified index
        cartItems.splice(index, 1);

        // Update localStorage with the modified cart items
        localStorage.setItem("cart", JSON.stringify(cartItems));
        
        // Update the UI to reflect the changes
        updateCartUI(cartItems);
    } else {
        console.error("Error: Invalid index specified.");
    }
}

{% endblock js %}